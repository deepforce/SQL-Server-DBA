# SQL Server Restore

## SIMPLE

small transaction log, doesn't keep details

## FULL

## BULK LOGGED





## 备份策略

RPO（Recovery Point Objective）恢复点目标

- 可以接受多少数据遗失？

RTO (Recovery Time Objective) 恢复时间目标

- 还原可以花费多久时间？

是否可以从其他来源还原数据？ 云服务器



## 备份策略对应的需求

- 备份的类型与频率
- 使用的备份介质
- 备份与介质的保存期限
- 备份测试原则
- 封存需求
- 可用的安全储存位置
- 还原备份所需的硬件
- 备份的完整性



## 恢复模式

### 事务日志

- 在需要时，回滚交易
- 出现故障时，还原数据库



- 事务日志依时间顺序循环写入
- 日志的截断原则基于恢复模式



### 简单

- 不允许做日志备份
- 自动截断日志以保持小的空间需求

### 完整

- 日志备份管理
- 避免因为数据文件损坏或遗失导致数据遗失

### 大容量日志

- 日志备份管理
- 可以增强大容量复制操作的效率
- 为许多大容量操作使用最少记录以减少日志的空间使用量



## SQL Server 备份类型概述

![](D:\Study\SQL-Server-DBA\imgs\备份类型.png)

### 完整数据库备份策略

- 包含主要数据文件的完整备份
- 在简单模式中，数据库只能还原到上次备份执行的时候
- 在数据不常被修改的生产环境中，可当作最佳解决方案或在测试环境中使用



**数据库备份备份的是结束时间点的备份**

只有做过一次完整备份，数据库才会变成完整恢复模式。



## 事务日志备份策略 （增量备份）

- 包含至少完整与事务日志备份
- 启用时间点恢复
- 在发生数据文件遗失时，允许数据库能够完整还原



## 差异日志备份策略

- 包含执行完整与差异数据库备份
- 差异备份只包括变更过的数据
- 用于数据库的某部分较其他剩余部分更频繁地被修改时的场景



**唯一缩小截断日志的是做事务日志备份**



## 部分与文件群组备份策略

- 对大型数据库而言，可以更快的备份与还原
- 管理更复杂
- 建议把文件组看作一个存储边界，不建议对单个文件做备份，最好是文件组级别
- 只要不是恢复主要文件组，在企业版上，恢复过程中，可以保持数据库联机。只有恢复的那一部分才需要脱机



历史数据不需要高频备份

只备新的数据

只备份组，只备份写属性

出现问题，恢复新的组就可以了

最小边界是文件组



## 其他考虑

- 备份系统数据库 master msdb
- 为了可以恢复损坏页，建议启用checksum
- 备份时可以指定64个备份设备，设备间的是带区集
- 使用mirror选项可以生成多个备份（最多4个）
- 通过压缩备份选项可以提高备份设备的速度，压缩一般可以达到4-10倍之多



## 还原备份文件的准备工作

- 每次执行尾日志备份时，必须使用完整恢复模式，或是大容量日志恢复模式
- 识别还原的备份：
  - 最新的完整备份、最新的文件备份、或是最新的文件组备份
  - 最新的差异备份（如果存在的话）
  - 事务日志备份，每次都必须使用完整还原模式，或是大容量日志恢复模式



灾难

1. tail-log bak
2. restore full
3. restore diff
4. restore log
5. restore log
6. tail-log 